<!-- 
Code written for the mapping community project
First example of the clustering 
Author: Daniel Hill
8th April 2016
danhilltravel@hotmail.c.ouk
-->
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet debug page</title>

<!-- Implements the javascript library without an API call -->
<script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
      heap.load("315187443");
</script>


<!-- Links required for the clustering to function -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="screen.css" />

	<link rel="stylesheet" href="Leaflet.markercluster/dist/MarkerCluster.css" />
	<link rel="stylesheet" href="Leaflet.markercluster/dist/MarkerCluster.Default.css" />
	<script src="Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

	   <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

</head>
<body>

 <!-- The set up for the map using a stamen terrain map -->   
	<div id="map"></div>

	<script type="text/javascript">
		      const map = L.map('map').setView([55.3781, -4.4360], 6);
              
              const tonerUrl = "http://{S}tile.stamen.com/watercolor/{Z}/{X}/{Y}.png";
              
              const url = tonerUrl.replace(/({[A-Z]})/g, s => s.toLowerCase());
              
              const basemap = L.tileLayer(url, {
                                          subdomains: ['', 'a.', 'b.', 'c.', 'd.'],
                                          minZoom: 0,
                                          maxZoom: 20,
                                          type: 'png',
                                          attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>'
                                          });
                                          

				basemap.addTo(map);



		var markers = new L.MarkerClusterGroup();
		var markersList = [];


  

//The implemntation of a for loop which loops over sql data
//It is then forming the pop up box with information inside
        


		function populate() {


			//fourth query and add with custom icons
  var query4 = "SELECT * FROM community_land";
   var community_land = L.geoJson(null).addTo(map);
      var sql4 = new cartodb.SQL({ user: 'kidwellj' });

      sql4.execute(query4, null, { format: 'geojson' })
      .done(function(data1) {


  //pop ups added and these are the custom options.

  var customOptions =
      {
      'maxWidth': '1600',
      'width': '900',
      'className' : 'popupCustom'
      }

			for (var i=0; i<data1.features.length; i++){
				
				var name = data1.features[i].properties.name;
          var url = data1.features[i].properties.url;
          console.log(data1);


          var customPopup = name + "<br/>" + 
         
         "<a href=\"http://" + url  + "\" >Click here for website</a>" +

         "<br/>" + "<p>Find out more information on this group</p>" +

         "<button type=\"button\">Click Me!</button>"


         ;

//finds the x and y co-ordinates from the sql statement              
              var y = data1.features[i].geometry.coordinates[0];
              var x = data1.features[i].geometry.coordinates[1];

               //adds the markers
               var markerLocation = new L.LatLng(x, y);
               var m = new L.Marker(markerLocation);
               
               //map.addLayer(m);
               var popupText = name;
           
               m.bindPopup(customPopup,customOptions);	

               //orginal marker setters
						//var m = new L.Marker(getRandomLatLng(map));
				markersList.push(m);
				markers.addLayer(m);
			}
		})
			return false;
		}

		//The cluster click which focuses in on a grouping of points 
		markers.on('clusterclick', function (a) {
			alert('cluster ' + a.layer.getAllChildMarkers().length);
		});
		
		markers.on('click', function (a) {
			
		});
		populate();
		map.addLayer(markers);


		//Additional functionality that is not implemneted but may be useful for reference
		L.DomUtil.get('populate').onclick = function () {
			var bounds = map.getBounds(),
			southWest = bounds.getSouthWest(),
			northEast = bounds.getNorthEast(),
			lngSpan = northEast.lng - southWest.lng,
			latSpan = northEast.lat - southWest.lat;
			var m = new L.Marker(new L.LatLng(
					southWest.lat + latSpan * 0.5,
					southWest.lng + lngSpan * 0.5));
			markersList.push(m);
			markers.addLayer(m);
		};
		L.DomUtil.get('remove').onclick = function () {
			markers.removeLayer(markersList.pop());
		};
	</script>
</body>
</html>