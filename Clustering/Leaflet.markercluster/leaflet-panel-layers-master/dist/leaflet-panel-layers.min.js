/* 
 * Leaflet Panel Layers v0.9.5 - 2017-06-08 
 * 
 * Copyright 2017 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demos: 
 * http://labs.easyblog.it/maps/leaflet-panel-layers/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-panel-layers.git 
 * 
 */

!function(e){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)module.exports=e(require("leaflet"));else{if(void 0===window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(e){return e.Control.PanelLayers=e.Control.Layers.extend({includes:e.Mixin.Events,options:{compact:!1,collapsed:!1,autoZIndex:!0,collapsibleGroups:!1,buildItem:null,title:"",className:"",position:"topright"},initialize:function(t,a,i){e.setOptions(this,i),this._layers={},this._groups={},this._items={},this._layersActives=[],this._lastZIndex=0,this._handlingClick=!1,this.className="leaflet-panel-layers";var s,r,o;for(s in t)if(t[s].group&&t[s].layers){o=t[s].collapsed||!1;for(r in t[s].layers)this._addLayer(t[s].layers[r],!1,t[s].group,o)}else this._addLayer(t[s],!1);for(s in a)if(a[s].group&&a[s].layers){o=a[s].collapsed||!1;for(r in a[s].layers)this._addLayer(a[s].layers[r],!0,a[s].group,o)}else this._addLayer(a[s],!0)},onAdd:function(t){var a=this;for(var i in this._layersActives)t.addLayer(this._layersActives[i]);return e.Control.Layers.prototype.onAdd.call(this,t),this._map.on("resize",function(e){a._updateHeight(e.newSize.y)}),this._container},addBaseLayer:function(e,t,a){return e.name=t||e.name||"",this._addLayer(e,!1,a),this._update(),this},addOverlay:function(e,t,a){return e.name=t||e.name||"",this._addLayer(e,!0,a),this._update(),this},removeLayer:function(t){var a=t.hasOwnProperty("layer")?this._layerFromDef(t):t;return this._map.removeLayer(a),e.Control.Layers.prototype.removeLayer.call(this,a),this},clearLayers:function(){for(var e in this._layers)this.removeLayer(this._layers[e])},_layerFromDef:function(e){for(var t in this._layers)if(this._layers[t].name===e.name)return this._layers[t].layer},_update:function(){this._groups={},this._items={},e.Control.Layers.prototype._update.call(this)},_addLayer:function(t,a,i,s){if(!t.layer)throw new Error("layer not defined in item: "+(t.name||""));t.layer instanceof e.Class||!t.layer.type||!t.layer.args||(t.layer=this._getPath(e,t.layer.type).apply(e,t.layer.args)),t.hasOwnProperty("id")||(t.id=e.stamp(t.layer)),t.active&&this._layersActives.push(t.layer),this._layers[t.id]=e.Util.extend(t,{collapsed:s,overlay:a,group:i}),this.options.autoZIndex&&t.layer&&t.layer.setZIndex&&(this._lastZIndex++,t.layer.setZIndex(this._lastZIndex))},_createItem:function(t){var a,i,s,r=this;a=e.DomUtil.create("div",this.className+"-item"+(t.active?" active":"")),s=this._map.hasLayer(t.layer),t.overlay?((i=e.DomUtil.create("input",this.className+"-selector")).type="checkbox",i.defaultChecked=s):i=this._createRadioElement("leaflet-base-layers",s),i.value=t.id,i._layer=t,e.DomEvent.on(i,"click",function(e){r._onInputClick(),e.target.checked?r.fire("panel:selected",e.target._layer):r.fire("panel:unselected",e.target._layer)},this);var o=e.DomUtil.create("label",this.className+"-title"),l=e.DomUtil.create("span");if(l.innerHTML=t.name||"",t.icon){var n=e.DomUtil.create("i",this.className+"-icon");"string"==typeof t.icon?n.innerHTML=t.icon||"":n.appendChild(t.icon),o.appendChild(n)}if(o.appendChild(i),o.appendChild(l),a.appendChild(o),this.options.buildItem){var h=this.options.buildItem.call(this,t);if("string"==typeof h){var c=e.DomUtil.create("div");c.innerHTML=h,a.appendChild(c.firstChild)}else a.appendChild(h)}return this._items[i.value]=a,a},_createRadioElement:function(e,t){var a='<input type="radio" class="'+this.className+'-selector" name="'+e+'"';t&&(a+=' checked="checked"'),a+=" />";var i=document.createElement("div");return i.innerHTML=a,i.firstChild},_addItem:function(e){var t,a=e.overlay?this._overlaysList:this._baseLayersList;if(e.group){if(e.group.hasOwnProperty("name")||(e.group={name:e.group}),!this._groups[e.group.name]){var i=!1;!0===e.collapsed&&(i=!0),this._groups[e.group.name]=this._createGroup(e.group,i)}a.appendChild(this._groups[e.group.name]),a=this._groups[e.group.name]}return t=this._createItem(e),a.appendChild(t),t},_createGroup:function(t,a){var i,s,r,o=this,l=e.DomUtil.create("div",this.className+"-group");return this.options.collapsibleGroups&&(e.DomUtil.addClass(l,"collapsible"),(r=e.DomUtil.create("i",this.className+"-icon",l)).innerHTML=!0===a?" + ":" - ",e.DomEvent.on(r,"click",function(){e.DomUtil.hasClass(l,"expanded")?(e.DomUtil.removeClass(l,"expanded"),r.innerHTML=" + "):(e.DomUtil.addClass(l,"expanded"),r.innerHTML=" - "),o._updateHeight()}),!1===a&&e.DomUtil.addClass(l,"expanded")),i=e.DomUtil.create("label",this.className+"-grouplabel",l),s=e.DomUtil.create("span",this.className+"-title",i),s.innerHTML=t.name,l},_onInputClick:function(){var t,a,i,s=this._form.getElementsByClassName(this.className+"-selector"),r=s.length;for(this._handlingClick=!0,t=0;t<r;t++)a=s[t],i=this._layers[a.value],a.checked&&!this._map.hasLayer(i.layer)?(e.DomUtil.addClass(a.parentNode.parentNode,"active"),this._map.addLayer(i.layer)):!a.checked&&this._map.hasLayer(i.layer)&&(e.DomUtil.removeClass(a.parentNode.parentNode,"active"),this._map.removeLayer(i.layer));this._handlingClick=!1,this._refocusOnMap()},_initLayout:function(){var t=this._container=e.DomUtil.create("div",this.className);if(t.setAttribute("aria-haspopup",!0),e.Browser.touch?e.DomEvent.on(t,"click",e.DomEvent.stopPropagation):e.DomEvent.disableClickPropagation(t).disableScrollPropagation(t),e.DomEvent.disableClickPropagation(t),this.options.className&&e.DomUtil.addClass(t,this.options.className),this._form=e.DomUtil.create("form",this.className+"-list"),this._updateHeight(),this.options.compact?e.DomUtil.addClass(t,"compact"):this._form.style.height=this._map.getSize().y+"px",this.options.collapsed){e.Browser.android||e.DomEvent.on(t,"mouseover",this._expand,this).on(t,"mouseout",this._collapse,this);var a=this._layersLink=e.DomUtil.create("a",this.className+"-toggle",t);a.href="#",a.title="Layers",e.Browser.touch?e.DomEvent.on(a,"click",e.DomEvent.stop).on(a,"click",this._expand,this):e.DomEvent.on(a,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();if(this._baseLayersList=e.DomUtil.create("div",this.className+"-base",this._form),this._separator=e.DomUtil.create("div",this.className+"-separator",this._form),this._overlaysList=e.DomUtil.create("div",this.className+"-overlays",this._form),this.options.compact||e.DomUtil.create("div",this.className+"-margin",this._form),this.options.title){var i=e.DomUtil.create("label",this.className+"-title");i.innerHTML="<span>"+this.options.title+"</span>",t.appendChild(i)}t.appendChild(this._form)},_updateHeight:function(e){e=e||this._map.getSize().y,this.options.compact?this._form.style.maxHeight=e-30+"px":this._form.style.height=e-30+"px"},_expand:function(){e.DomUtil.addClass(this._container,"expanded")},_collapse:function(){this._container.className=this._container.className.replace("expanded","")},_getPath:function(e,t){var a=t.split("."),i=a.pop(),s=a.length,r=a[0],o=1;if(s>0)for(;(e=e[r])&&o<s;)r=a[o++];if(e)return e[i]}}),e.control.panelLayers=function(t,a,i){return new e.Control.PanelLayers(t,a,i)},e.Control.PanelLayers});